<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>SafeFlow ‚Äì Kelantan Flood Decision Map</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<!-- Leaflet Routing Machine -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

<style>
html, body { height:100%; margin:0; }
#map { height:100%; width:100%; }

.legend {
  background:white;
  padding:10px;
  font-size:14px;
  line-height:1.5;
}
.legend i {
  width:14px;
  height:14px;
  float:left;
  margin-right:8px;
}
</style>
</head>

<body>
<div id="map"></div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
/*************************************************
 * MAP INIT
 *************************************************/
const map = L.map("map").setView([5.56, 102.19], 10);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution:"¬© OpenStreetMap contributors"
}).addTo(map);

L.control.scale().addTo(map);

/*************************************************
 * FIREBASE
 *************************************************/
const FIREBASE_URL =
"https://safeflow-68707-default-rtdb.asia-southeast1.firebasedatabase.app/sensors/A.json";

async function fetchFirebaseData() {
  const res = await fetch(FIREBASE_URL);
  return await res.json();
}

/*************************************************
 * GLOBAL STATE
 *************************************************/
let geoLayer = null;
let heatLayer = null;
let routingControl = null;
let userMarker = null;

/*************************************************
 * FLOOD ZONES (LOGICAL MODEL)
 *************************************************/
const zones = [
  { id:"Sensor (Kuala Krai)", lat:5.560, lng:102.190, offset:0 },
  { id:"Upstream Plains", lat:5.520, lng:102.170, offset:-15 },
  { id:"Mid Basin", lat:5.620, lng:102.200, offset:+5 },
  { id:"Tanah Merah Floodplain", lat:5.800, lng:102.080, offset:+20 },
  { id:"Kota Bharu Basin", lat:6.130, lng:102.240, offset:+35 },
  { id:"Urban Core", lat:6.132, lng:102.242, offset:+45 },
  { id:"Highland Edge", lat:6.150, lng:102.180, offset:-20 }
];

/*************************************************
 * STATIC ELEMENTS
 *************************************************/
const shelterLatLng = L.latLng(6.170, 102.150);

L.marker(shelterLatLng)
  .bindPopup("<b>Safe Shelter</b><br>High Ground Evacuation Center")
  .addTo(map);

/*************************************************
 * GPS (DEVTOOLS OR PHONE)
 *************************************************/
function getUserLocation() {
  if (!navigator.geolocation) return;

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    if (!userMarker) {
      userMarker = L.marker([lat, lng])
        .bindPopup("üìç You are here")
        .addTo(map);

      startRouting(lat, lng);
    } else {
      userMarker.setLatLng([lat, lng]);
      updateRoutePosition(lat, lng);
    }
  });
}

/*************************************************
 * ROUTING (OSRM ‚Äì NO ERRORS)
 *************************************************/
function startRouting(lat, lng) {
  routingControl = L.Routing.control({
    waypoints: [
      L.latLng(lat, lng),
      shelterLatLng
    ],
    createMarker: () => null,
    addWaypoints: false,
    draggableWaypoints: false,
    routeWhileDragging: false,
    lineOptions: {
      styles: [{ color:"blue", weight:5 }]
    }
  }).addTo(map);
}

function updateRoutePosition(lat, lng) {
  if (!routingControl) return;
  routingControl.getPlan().setWaypoints([
    L.latLng(lat, lng),
    shelterLatLng
  ]);
}

function setRouteColor(color) {
  if (!routingControl) return;
  routingControl.setLineOptions({
    styles:[{ color:color, weight:5 }]
  });
}

/*************************************************
 * MAP UPDATE
 *************************************************/
async function updateMap() {
  const sensor = await fetchFirebaseData();
  if (!sensor || sensor.risk === undefined) return;

  const features = [];
  const heatData = [];

  zones.forEach(z => {
    const risk = Math.max(0, Math.min(100, sensor.risk + z.offset));

    features.push({
      type:"Feature",
      geometry:{ type:"Point", coordinates:[z.lng, z.lat] },
      properties:{ zone:z.id, risk }
    });

    heatData.push([z.lat, z.lng, risk / 100]);
  });

  if (geoLayer) geoLayer.remove();
  if (heatLayer) heatLayer.remove();

  geoLayer = L.geoJSON(
    { type:"FeatureCollection", features },
    {
      pointToLayer:(f,latlng)=>{
        const r = f.properties.risk;
        const c = r<30?"green":r<60?"yellow":"red";
        return L.circleMarker(latlng,{
          radius:14, fillColor:c, color:"#000", weight:1, fillOpacity:0.9
        });
      }
    }
  ).addTo(map);

  heatLayer = L.heatLayer(heatData,{
    radius:120, blur:70, maxZoom:11
  }).addTo(map);

  // üö® Risk-based evacuation cue
  const urban = features.find(f=>f.properties.zone==="Urban Core");
  if (urban && routingControl) {
    setRouteColor(urban.properties.risk >= 60 ? "red" : "blue");
  }
}

/*************************************************
 * LEGEND
 *************************************************/
L.control({ position:"bottomright" }).onAdd = function () {
  const div = L.DomUtil.create("div","legend");
  div.innerHTML = `
    <b>Flood Risk</b><br>
    <i style="background:green"></i> Low<br>
    <i style="background:yellow"></i> Moderate<br>
    <i style="background:red"></i> High<br>
    <hr>
    <b>üõ£Ô∏è Route</b><br>
    Blue: Normal<br>
    Red: Evacuation
  `;
  return div;
}.addTo(map);

/*************************************************
 * LIVE LOOP
 *************************************************/
updateMap();
getUserLocation();

setInterval(updateMap, 3000);
setInterval(getUserLocation, 5000);
</script>
</body>
</html>
