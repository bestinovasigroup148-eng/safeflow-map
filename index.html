<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SafeFlow ‚Äì UKM Bangi Live Evacuation Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

<style>
html, body { height:100%; margin:0; }
#map { height:100%; width:100%; }

.legend {
  background:white;
  padding:12px;
  font-size:14px;
  line-height:1.6;
  border-radius:8px;
  box-shadow:0 0 15px rgba(0,0,0,0.25);
}

.legend i {
  width:16px;
  height:16px;
  float:left;
  margin-right:8px;
}

.circle { border-radius:50%; }

.emoji-icon {
  font-size:24px;
  text-align:center;
  line-height:24px;
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
/*************************************************
 * MAP INIT
 *************************************************/
const map = L.map("map").setView([2.94, 101.76], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution:"¬© OpenStreetMap contributors"
}).addTo(map);

/*************************************************
 * FIREBASE ENDPOINTS
 *************************************************/
const SENSOR_URL =
"https://safeflow-68707-default-rtdb.asia-southeast1.firebasedatabase.app/sensors/A.json";

const AI_URL =
"https://safeflow-68707-default-rtdb.asia-southeast1.firebasedatabase.app/ai/A.json";

async function fetchJSON(url){
  try{
    const res = await fetch(url);
    return await res.json();
  }catch(e){
    console.error("Fetch error:",e);
    return null;
  }
}

/*************************************************
 * ICONS
 *************************************************/
const userIcon = L.divIcon({
  className:'emoji-icon',
  html:'üèÉ',
  iconSize:[30,30],
  iconAnchor:[15,15]
});

const shelterIcon = L.divIcon({
  className:'emoji-icon',
  html:'üè†',
  iconSize:[30,30],
  iconAnchor:[15,15]
});

/*************************************************
 * SAFE SHELTER
 *************************************************/
const shelterLatLng = L.latLng(2.9500, 101.7200);

L.marker(shelterLatLng,{icon:shelterIcon})
 .bindPopup("<b>SAFE SHELTER</b><br>High Ground")
 .addTo(map);

/*************************************************
 * FLOOD ZONES
 *************************************************/
const floodZones = [
  { name:"UKM Bangi Lowland", lat:2.9316, lng:101.7712, offset:30 },
  { name:"Bandar Baru Bangi Section 15", lat:2.9636, lng:101.7554, offset:40 },
  { name:"Sungai Langat Floodplain", lat:2.9781, lng:101.7898, offset:45 },
  { name:"Nexus International School", lat:2.9289, lng:101.6879, offset:30 },
  { name:"KTM UKM (KB07)", lat:2.9229, lng:101.7651, offset:25 },
  { name:"Bangunan Sains Kimia UKM", lat:2.9248, lng:101.7746, offset:20 }
];

/*************************************************
 * GLOBAL STATE
 *************************************************/
let geoLayer = null;
let heatLayer = null;
let routingControl = null;
let userMarker = null;
let lastAlertTime = 0;

/*************************************************
 * ROUTING
 *************************************************/
function updateRoute(lat,lng){
  if(!routingControl){
    routingControl = L.Routing.control({
      waypoints:[ L.latLng(lat,lng), shelterLatLng ],
      createMarker:()=>null,
      addWaypoints:false,
      draggableWaypoints:false,
      showAlternatives:false,
      lineOptions:{ styles:[{color:"red",weight:6,opacity:0.9}] }
    }).addTo(map);
  }else{
    routingControl.getPlan().setWaypoints([
      L.latLng(lat,lng),
      shelterLatLng
    ]);
  }
}

/*************************************************
 * LIVE GPS
 *************************************************/
function startLiveLocation(){
  if(!navigator.geolocation){
    alert("Geolocation not supported");
    return;
  }

  navigator.geolocation.watchPosition(pos=>{
    const {latitude,longitude} = pos.coords;

    if(!userMarker){
      userMarker = L.marker([latitude,longitude],{icon:userIcon})
        .bindPopup("<b>You (Live Location)</b>")
        .addTo(map);
      map.setView([latitude,longitude],15);
    }else{
      userMarker.setLatLng([latitude,longitude]);
    }

    updateRoute(latitude,longitude);
  });
}

/*************************************************
 * MAP UPDATE (AI-CLEAN)
 *************************************************/
async function updateMap(){

  const ai = await fetchJSON(AI_URL);
  if(!ai) return;

  let baseRisk =
    ai.riskCategory === 2 ? 80 :
    ai.riskCategory === 1 ? 50 : 20;

  baseRisk *= ai.confidence ?? 1;

  const features = [];
  const heatData = [];

  floodZones.forEach(z=>{
    const risk = Math.min(100, baseRisk + z.offset);
    const color = risk < 30 ? "green" : risk < 60 ? "yellow" : "red";

    features.push({
      type:"Feature",
      geometry:{type:"Point",coordinates:[z.lng,z.lat]},
      properties:{name:z.name,risk,color}
    });

    heatData.push([z.lat, z.lng, Math.min(2.5, risk / 35)]);
  });

  if(geoLayer) geoLayer.remove();
  if(heatLayer) heatLayer.remove();

  geoLayer = L.geoJSON(
    {type:"FeatureCollection",features},
    {
      pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
        radius:18,
        fillColor:f.properties.color,
        color:"#000",
        weight:1,
        fillOpacity:0.8
      }),
      onEachFeature:(f,l)=>{
        l.bindPopup(
          `<b>${f.properties.name}</b><br>
           Risk: ${Math.round(f.properties.risk)}%<br><br>

           ‚è± Time to danger: ${
             ai.timeToDanger === -1 ? "SAFE" : ai.timeToDanger + " s"
           }<br>

           üìà Predicted water level: ${
             ai.predictedWaterLevel.toFixed(1)
           } mm<br>

           üìä Trend: ${
             ai.trendType === 1 ? "RISING" :
             ai.trendType === 2 ? "FALLING" : "STABLE"
           }<br>

           ‚ö†Ô∏è Anomaly detected: ${
             ai.anomalyFlag ? "YES" : "NO"
           }<br>

           üîÅ Time above threshold: ${
             ai.timeAboveThreshold.toFixed(1)
           } s<br>

           üöÄ Acceleration: ${
             ai.acceleration.toFixed(2)
           } mm/s¬≤<br>

           ü§ñ AI confidence: ${
             (ai.confidence * 100).toFixed(0)
           }%
          `
        );
      }
    }
  ).addTo(map);

  heatLayer = L.heatLayer(heatData,{
    radius:120,
    blur:70,
    maxZoom:15
  }).addTo(map);

  const now = Date.now();
  if(ai.timeToDanger !== -1 && ai.timeToDanger < 300 &&
     ai.confidence > 0.7 && now-lastAlertTime>20000){
    alert("‚ö†Ô∏è Flood predicted soon!\nEvacuate immediately!");
    lastAlertTime = now;
  }
}

/*************************************************
 * LEGEND
 *************************************************/
const legend = L.control({position:"bottomright"});
legend.onAdd = function(){
  const div = L.DomUtil.create("div","legend");
  div.innerHTML = `
    <b>Legend</b><br>
    üèÉ Live User<br>
    üè† Safe Shelter<br><hr>
    <i class="circle" style="background:red"></i> High Risk<br>
    <i class="circle" style="background:yellow"></i> Moderate Risk<br>
    <i class="circle" style="background:green"></i> Low Risk<br><hr>
    <b style="color:red">‚îÅ Evacuation Route</b>
  `;
  return div;
};
legend.addTo(map);

/*************************************************
 * START
 *************************************************/
updateMap();
startLiveLocation();
setInterval(updateMap,3000);
</script>
</body>
</html>
